# Enhanced Registry with URN patterns, relationships, and generation rules
# Completely generic and configurable - no hardcoded assumptions

# Configuration for registry structure and processing
registry_config:
  required_sections: ["entities", "urn_patterns", "aspect_types", "aspects", "utility_functions"]
  enabled_utility_functions: ["sanitize_id", "email_to_username", "mask_secret", "utc_now_ms"]

# Section configuration - all section names are configurable
section_config:
  metadata_section: "metadata"
  urn_patterns_section: "urn_patterns"
  aspects_section: "aspects"
  entities_section: "entities"
  aspect_types_section: "aspect_types"
  aspect_relationships_section: "aspect_relationships"

# Field processing configuration
field_processing:
  skip_fields: ["template"]
  context_fields: ["pattern", "generators"]
  prefix_config:
    section: "metadata"
    field: "urn_prefix"

# Context configuration
context_config:
  pattern_field: "pattern"
  generators_field: "generators"

# Aspect processing configuration
aspect_processing:
  properties_field: "properties"
  context_exclude_fields: ["aspect"]

# Entity configuration
entity_config:
  urn_generator_field: "urn_generator"
  properties_field: "properties"

# Relationship configuration
relationship_config:
  rules_field: "rules"
  entity_type_field: "entity_type"

# Aspect configuration
aspect_config:
  type_field: "type"
  entity_creation_field: "entity_creation"

# Aspect context configuration
aspect_context_config:
  aspect_field: "aspect"

# List processing configuration
list_processing:
  dependency_patterns: ["depend"]

# String processing configuration
string_processing:
  pattern_field: "pattern"
  value_field: "value"
  when_value_present_field: "when_value_present"
  when_value_absent_field: "when_value_absent"

# Utility function definitions - completely generic
utility_functions:
  sanitize_id:
    type: "string_processing"
    description: "Sanitize string by removing invalid characters"
    parameters: ["raw"]
    implementation:
      operation: "regex_replace"
      pattern_config: "sanitize_pattern"
      replacement_config: "sanitize_replacement"
      pre_processing: "strip"
      strip_method_config: "strip_method"
  
  email_to_username:
    type: "string_processing"
    description: "Extract username from email address"
    parameters: ["email"]
    implementation:
      operation: "split_and_extract"
      separator_config: "email_separator"
      split_limit_config: "split_limit"
      split_index_config: "split_index"
      post_processing: "regex_replace"
      pattern_config: "sanitize_pattern"
      replacement_config: "sanitize_replacement"
  
  mask_secret:
    type: "data_masking"
    description: "Mask sensitive data in key-value pairs"
    parameters: ["key", "value"]
    implementation:
      operation: "conditional_replace"
      condition: "regex_match"
      pattern_config: "secret_pattern"
      regex_flag_config: "regex_flag"
      replacement_config: "mask_replacement"
  
  utc_now_ms:
    type: "timestamp"
    description: "Get current UTC timestamp in milliseconds"
    parameters: []
    implementation:
      operation: "datetime_now"
      method_config: "now_method"
      timezone_config: "timezone"
      post_processing: "timestamp_multiply"
      multiplier_config: "timestamp_multiplier"

# Utility function configuration
utility_config:
  # sanitize_id function configuration
  sanitize_pattern: "[^a-zA-Z0-9_.-]+"
  sanitize_replacement: "_"
  strip_method: "strip"
  
  # email_to_username function configuration
  email_separator: "@"
  split_limit: 1
  split_index: 0
  
  # mask_secret function configuration
  secret_pattern: "(pass|secret|key|token)"
  mask_replacement: "****"
  regex_flag: "IGNORECASE"
  
  # utc_now_ms function configuration
  now_method: "now"
  timezone: "UTC"
  timestamp_multiplier: 1000

# Relationship rule configuration
relationship_rule_config:
  relationship_type_field: "relationship_type"
  source_entity_field: "source_entity"
  target_entity_field: "target_entity"
  direction_field: "direction"
  field_mapping_field: "field_mapping"
  additional_relationships_field: "additional_relationships"
  source_field_name: "source_field"
  target_field_name: "target_field"
  source_entity_type_name: "source_entity_type"
  target_entity_type_name: "target_entity_type"
  source_urn_field_name: "source_urn_field"
  target_urn_field_name: "target_urn_field"
  array_separator: "[]"
  default_direction: "outgoing"
  default_target_field: "urn"
  outgoing_direction: "outgoing"
  urn_field_name: "urn"

metadata:
  version: "1.0"
  description: "Enhanced registry for dynamic Neo4jMetadataWriter generation"
  urn_prefix: "urn:li"

# URN Generation Patterns
urn_patterns:
  dataPlatform:
    template: "{prefix}:dataPlatform:{platform}"
    parameters: ["platform"]
    sanitize: ["platform"]
  
  dataset:
    template: "{prefix}:dataset:({data_platform_urn},{name},{env})"
    parameters: ["platform", "name", "env"]
    defaults: {"env": "PROD"}
    dependencies: ["dataPlatform"]
    sanitize: ["name"]
  
  dataFlow:
    template: "{prefix}:dataFlow:({platform},{flow_id},{env})"
    parameters: ["platform", "flow_id", "env"]
    defaults: {"env": "PROD"}
    sanitize: ["platform", "flow_id"]
  
  dataJob:
    template: "{prefix}:dataJob:({flow_urn},{job_name})"
    parameters: ["flow_urn", "job_name"]
    sanitize: ["job_name"]
  
  corpUser:
    template: "{prefix}:corpuser:{username}"
    parameters: ["username"]
    sanitize: ["username"]
    transformations: {"username": "email_to_username"}
  
  corpGroup:
    template: "{prefix}:corpGroup:{groupname}"
    parameters: ["groupname"]
    sanitize: ["groupname"]
  
  tag:
    template: "{prefix}:tag:{key}{value_suffix}"
    parameters: ["key", "value"]
    sanitize: ["key", "value"]
    conditional_logic: "value_suffix"
    conditional_rules:
      value_suffix:
        when_value_present: "={value}"
        when_value_absent: ""
  
  column:
    template: "{dataset_urn}#{field_path}"
    parameters: ["dataset_urn", "field_path"]
    sanitize: ["field_path"]

# Aspect Definitions
aspects:
  corpUserInfo:
    type: versioned
    properties:
      - active
      - displayName
      - email
      - title
      - department
      - managerUrn
      - skills
    required: ["active", "displayName", "email"]
    defaults:
      active: true
    # Entity creation parameters for independent ingestion
    entity_creation:
      entity_type: "CorpUser"
      urn_generator: "corpUser"
      required_params: ["username"]
      optional_params: []
  
  corpGroupInfo:
    type: versioned
    properties:
      - name
      - description
      - email
      - slackChannel
    required: ["name"]
    entity_creation:
      entity_type: "CorpGroup"
      urn_generator: "corpGroup"
      required_params: ["name"]
      optional_params: []
  
  datasetProperties:
    type: versioned
    properties:
      - description
      - customProperties
      - tags
      - externalUrl
    required: ["description"]
    entity_creation:
      entity_type: "Dataset"
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  schemaMetadata:
    type: versioned
    properties:
      - schemaName
      - platform
      - version
      - fields
      - primaryKeys
      - foreignKeys
    required: ["schemaName", "platform", "fields"]
    entity_creation:
      entity_type: "Dataset"
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  ownership:
    type: versioned
    properties:
      - owners
      - lastModified
    required: ["owners"]
    # Ownership can be attached to multiple entity types
    # Entity creation will be determined by the context where it's used
    entity_creation:
      entity_type: "Dataset"  # Default to Dataset, but can be overridden
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  globalTags:
    type: versioned
    properties:
      - tags
    required: ["tags"]
    # Global tags can be attached to multiple entity types
    # Entity creation will be determined by the context where it's used
    entity_creation:
      entity_type: "Dataset"  # Default to Dataset, but can be overridden
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  datasetProfile:
    type: timeseries
    properties:
      - rowCount
      - columnCount
      - sizeInBytes
      - lastModified
      - partitionCount
    required: ["rowCount", "columnCount"]
    entity_creation:
      entity_type: "Dataset"
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  dataFlowInfo:
    type: versioned
    properties:
      - name
      - namespace
      - description
      - version
    required: ["name", "namespace"]
    entity_creation:
      entity_type: "DataFlow"
      urn_generator: "dataFlow"
      required_params: ["platform", "flow_id"]
      optional_params: ["env"]
  
  dataJobInfo:
    type: versioned
    properties:
      - name
      - namespace
      - versionId
      - integration
      - processingType
      - jobType
      - description
    required: ["name", "namespace"]
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  documentation:
    type: versioned
    properties:
      - description
      - contentType
      - content
    required: ["description"]
    # Documentation is typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  sourceCodeLocation:
    type: versioned
    properties:
      - type
      - url
      - repo
      - branch
      - path
    required: ["type", "url"]
    # Source code location is typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  sourceCode:
    type: versioned
    properties:
      - language
      - snippet
      - fullCode
    required: ["language"]
    # Source code is typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  environmentProperties:
    type: versioned
    properties:
      - env
      - config
    required: ["env"]
    # Environment properties are typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  dataJobInputOutput:
    type: versioned
    properties:
      - inputs
      - outputs
    required: ["inputs", "outputs"]
    # Data job I/O is typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  dataJobRun:
    type: timeseries
    properties:
      - eventType
      - runId
      - parent
      - status
      - startTime
      - endTime
    required: ["eventType", "runId"]
    # Data job runs are typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  columnProperties:
    type: versioned
    properties:
      - description
      - dataType
      - nullable
      - defaultValue
    required: ["dataType"]
    entity_creation:
      entity_type: "Column"
      urn_generator: "column"
      required_params: ["dataset_urn", "field_path"]
      optional_params: []
  
  transformation:
    type: versioned
    properties:
      - inputColumns
      - steps
      - notes
      - sourceDataset
      - targetDataset
      - transformationType
    required: ["inputColumns", "transformationType"]
    defaults:
      sourceDataset: null
      targetDataset: null
    entity_creation:
      entity_type: "Column"
      urn_generator: "column"
      required_params: ["dataset_urn", "field_path"]
      optional_params: []

# Entity Definitions
entities:
  Dataset:
    key: datasetKey
    urn_generator: dataset
    properties:
      - platform
      - name
      - env
      - versionId
    aspects:
      datasetProperties: versioned
      schemaMetadata: versioned
      ownership: versioned
      globalTags: versioned
      datasetProfile: timeseries

  DataFlow:
    key: dataFlowKey
    urn_generator: dataFlow
    properties:
      - platform
      - flow_id
      - namespace
      - name
      - env
    aspects:
      dataFlowInfo: versioned

  DataJob:
    key: dataJobKey
    urn_generator: dataJob
    properties:
      - flow_urn
      - job_name
    aspects:
      dataJobInfo: versioned
      documentation: versioned
      sourceCodeLocation: versioned
      sourceCode: versioned
      environmentProperties: versioned
      ownership: versioned
      dataJobInputOutput: versioned
      dataJobRun: timeseries

  CorpUser:
    key: corpUserKey
    urn_generator: corpUser
    properties:
      - username
    aspects:
      corpUserInfo: versioned
      ownership: versioned

  CorpGroup:
    key: corpGroupKey
    urn_generator: corpGroup
    properties:
      - name
    aspects:
      corpGroupInfo: versioned
      ownership: versioned

  Tag:
    key: tagKey
    urn_generator: tag
    properties:
      - key
      - value
    aspects: {}

  Column:
    key: columnKey
    urn_generator: column
    properties:
      - dataset_urn
      - field_path
    aspects:
      columnProperties: versioned
      transformation: versioned

# Aspect Types
aspect_types:
  versioned:
    base_class: "Versioned"
    properties: ["id", "name", "version", "kind", "json", "createdAt"]
    query_pattern: "MATCH (e:{entity_label} {{urn:$urn}})-[:HAS_ASPECT {{name:$an}}]->(a:Aspect:Versioned)"
  
  timeseries:
    base_class: "TimeSeries"
    properties: ["id", "name", "ts", "kind", "json", "createdAt"]
    query_pattern: "MATCH (e:{entity_label} {{urn:$urn}})-[:HAS_ASPECT {{name:$an}}]->(a:Aspect:TimeSeries)"

# Aspect-Driven Relationship Rules
aspect_relationships:
  ownership:
    description: "Creates OWNS relationships from ownership aspect data"
    rules:
      - entity_type: "Dataset"
        relationship_type: "OWNS"
        source_entity: "CorpUser"
        target_entity: "Dataset"
        direction: "incoming"
        field_mapping:
          source_field: "owners[].owner"
          source_entity_type: "CorpUser"
          source_urn_field: "username"
          target_entity_type: "Dataset"
          target_urn_field: "urn"
      - entity_type: "DataJob"
        relationship_type: "OWNS"
        source_entity: "CorpUser"
        target_entity: "DataJob"
        direction: "incoming"
        field_mapping:
          source_field: "owners[].owner"
          source_entity_type: "CorpUser"
          source_urn_field: "username"
          target_entity_type: "DataJob"
          target_urn_field: "urn"

  globalTags:
    description: "Creates TAGGED relationships from globalTags aspect data"
    rules:
      - entity_type: "Dataset"
        relationship_type: "TAGGED"
        source_entity: "Dataset"
        target_entity: "Tag"
        direction: "outgoing"
        field_mapping:
          source_field: "tags[].tag"
          source_entity_type: "Dataset"
          source_urn_field: "urn"
          target_entity_type: "Tag"
          target_urn_field: "key"

  transformation:
    description: "Creates DERIVES_FROM, TRANSFORMS and UPSTREAM_OF relationships from transformation aspect data"
    rules:
      - entity_type: "Column"
        relationship_type: "DERIVES_FROM"
        source_entity: "Column"
        target_entity: "Column"
        direction: "outgoing"
        field_mapping:
          source_field: "inputColumns[]"
          source_entity_type: "Column"
          source_urn_field: "urn"
          target_entity_type: "Column"
          target_urn_field: "urn"
          source_urn_template: "{sourceDataset}#{source_field}"
          target_urn_template: "{targetDataset}#{field_path}"
      - entity_type: "Column"
        relationship_type: "TRANSFORMS"
        source_entity: "Column"
        target_entity: "Column"
        direction: "incoming"
        field_mapping:
          source_field: "inputColumns[]"
          source_entity_type: "Column"
          source_urn_field: "urn"
          target_entity_type: "Column"
          target_urn_field: "urn"
          source_urn_template: "{sourceDataset}#{source_field}"
          target_urn_template: "{targetDataset}#{field_path}"
        additional_relationships:
          - relationship_type: "UPSTREAM_OF"
            source_entity: "Dataset"
            target_entity: "Dataset"
            direction: "outgoing"
            field_mapping:
              source_field: "sourceDataset"
              target_field: "targetDataset"

  schemaMetadata:
    description: "Creates HAS_COLUMN relationships from schemaMetadata aspect data"
    rules:
      - entity_type: "Dataset"
        relationship_type: "HAS_COLUMN"
        source_entity: "Dataset"
        target_entity: "Column"
        direction: "outgoing"
        field_mapping:
          source_field: "fields[].fieldPath"
          source_entity_type: "Dataset"
          source_urn_field: "urn"
          target_entity_type: "Column"
          target_urn_field: "urn"
          target_urn_template: "{source_urn}#{source_field}"

  dataJobInputOutput:
    description: "Creates CONSUMES and PRODUCES relationships from dataJobInputOutput aspect data"
    rules:
      - entity_type: "DataJob"
        relationship_type: "CONSUMES"
        source_entity: "DataJob"
        target_entity: "Dataset"
        direction: "outgoing"
        field_mapping:
          source_field: "inputs[]"
          source_entity_type: "DataJob"
          source_urn_field: "urn"
          target_entity_type: "Dataset"
          target_urn_field: "urn"
      - entity_type: "DataJob"
        relationship_type: "PRODUCES"
        source_entity: "DataJob"
        target_entity: "Dataset"
        direction: "outgoing"
        field_mapping:
          source_field: "outputs[]"
          source_entity_type: "DataJob"
          source_urn_field: "urn"
          target_entity_type: "Dataset"
          target_urn_field: "urn"

  dataFlowInfo:
    description: "Creates HAS_JOB relationships from dataFlowInfo aspect data"
    rules:
      - entity_type: "DataFlow"
        relationship_type: "HAS_JOB"
        source_entity: "DataFlow"
        target_entity: "DataJob"
        direction: "outgoing"
        field_mapping:
          source_field: "jobs[]"
          source_entity_type: "DataFlow"
          source_urn_field: "urn"
          target_entity_type: "DataJob"
          target_urn_field: "urn"
          target_urn_template: "{source_urn}#{source_field}"
