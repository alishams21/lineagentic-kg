# Enhanced Registry with URN patterns, relationships, and generation rules
metadata:
  version: "1.0"
  description: "Enhanced registry for dynamic Neo4jMetadataWriter generation"
  urn_prefix: "urn:li"

# URN Generation Patterns
urn_patterns:
  dataPlatform:
    template: "{prefix}:dataPlatform:{platform}"
    parameters: ["platform"]
    sanitize: ["platform"]
  
  dataset:
    template: "{prefix}:dataset:({data_platform_urn},{name},{env})"
    parameters: ["platform", "name", "env"]
    defaults: {"env": "PROD"}
    dependencies: ["dataPlatform"]
    sanitize: ["name"]
  
  dataFlow:
    template: "{prefix}:dataFlow:({platform},{flow_id},{env})"
    parameters: ["platform", "flow_id", "env"]
    defaults: {"env": "PROD"}
    sanitize: ["platform", "flow_id"]
  
  dataJob:
    template: "{prefix}:dataJob:({flow_urn},{job_name})"
    parameters: ["flow_urn", "job_name"]
    sanitize: ["job_name"]
  
  corpUser:
    template: "{prefix}:corpuser:{username}"
    parameters: ["username"]
    sanitize: ["username"]
    transformations: {"username": "email_to_username"}
  
  corpGroup:
    template: "{prefix}:corpGroup:{groupname}"
    parameters: ["groupname"]
    sanitize: ["groupname"]
  
  tag:
    template: "{prefix}:tag:{key}{value_suffix}"
    parameters: ["key", "value"]
    sanitize: ["key", "value"]
    conditional_logic: "value_suffix"
    conditional_rules:
      value_suffix:
        when_value_present: "={value}"
        when_value_absent: ""
  
  column:
    template: "{dataset_urn}#{field_path}"
    parameters: ["dataset_urn", "field_path"]
    sanitize: ["field_path"]

# Aspect Definitions
aspects:
  corpUserInfo:
    type: versioned
    properties:
      - active
      - displayName
      - email
      - title
      - department
      - managerUrn
      - skills
    required: ["active", "displayName", "email"]
    defaults:
      active: true
    # Entity creation parameters for independent ingestion
    entity_creation:
      entity_type: "CorpUser"
      urn_generator: "corpUser"
      required_params: ["username"]
      optional_params: []
  
  corpGroupInfo:
    type: versioned
    properties:
      - name
      - description
      - email
      - slackChannel
    required: ["name"]
    entity_creation:
      entity_type: "CorpGroup"
      urn_generator: "corpGroup"
      required_params: ["name"]
      optional_params: []
  
  datasetProperties:
    type: versioned
    properties:
      - description
      - customProperties
      - tags
      - externalUrl
    required: ["description"]
    entity_creation:
      entity_type: "Dataset"
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  schemaMetadata:
    type: versioned
    properties:
      - schemaName
      - platform
      - version
      - fields
      - primaryKeys
      - foreignKeys
    required: ["schemaName", "platform", "fields"]
    entity_creation:
      entity_type: "Dataset"
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  ownership:
    type: versioned
    properties:
      - owners
      - lastModified
    required: ["owners"]
    # Ownership can be attached to multiple entity types
    # Entity creation will be determined by the context where it's used
    entity_creation:
      entity_type: "Dataset"  # Default to Dataset, but can be overridden
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  globalTags:
    type: versioned
    properties:
      - tags
    required: ["tags"]
    # Global tags can be attached to multiple entity types
    # Entity creation will be determined by the context where it's used
    entity_creation:
      entity_type: "Dataset"  # Default to Dataset, but can be overridden
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  datasetProfile:
    type: timeseries
    properties:
      - rowCount
      - columnCount
      - sizeInBytes
      - lastModified
      - partitionCount
    required: ["rowCount", "columnCount"]
    entity_creation:
      entity_type: "Dataset"
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  dataFlowInfo:
    type: versioned
    properties:
      - name
      - namespace
      - description
      - version
    required: ["name", "namespace"]
    entity_creation:
      entity_type: "DataFlow"
      urn_generator: "dataFlow"
      required_params: ["platform", "flow_id"]
      optional_params: ["env"]
  
  dataJobInfo:
    type: versioned
    properties:
      - name
      - namespace
      - versionId
      - integration
      - processingType
      - jobType
      - description
    required: ["name", "namespace"]
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  documentation:
    type: versioned
    properties:
      - description
      - contentType
      - content
    required: ["description"]
    # Documentation is typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  sourceCodeLocation:
    type: versioned
    properties:
      - type
      - url
      - repo
      - branch
      - path
    required: ["type", "url"]
    # Source code location is typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  sourceCode:
    type: versioned
    properties:
      - language
      - snippet
      - fullCode
    required: ["language"]
    # Source code is typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  environmentProperties:
    type: versioned
    properties:
      - env
      - config
    required: ["env"]
    # Environment properties are typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  dataJobInputOutput:
    type: versioned
    properties:
      - inputs
      - outputs
    required: ["inputs", "outputs"]
    # Data job I/O is typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  dataJobRun:
    type: timeseries
    properties:
      - eventType
      - runId
      - parent
      - status
      - startTime
      - endTime
    required: ["eventType", "runId"]
    # Data job runs are typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  columnProperties:
    type: versioned
    properties:
      - description
      - dataType
      - nullable
      - defaultValue
    required: ["dataType"]
    entity_creation:
      entity_type: "Column"
      urn_generator: "column"
      required_params: ["dataset_urn", "field_path"]
      optional_params: []
  
  transformation:
    type: versioned
    properties:
      - inputColumns
      - steps
      - notes
      - sourceDataset
      - targetDataset
      - transformationType
    required: ["inputColumns", "transformationType"]
    defaults:
      sourceDataset: null
      targetDataset: null
    entity_creation:
      entity_type: "Column"
      urn_generator: "column"
      required_params: ["dataset_urn", "field_path"]
      optional_params: []

# Entity Definitions
entities:
  Dataset:
    key: datasetKey
    urn_generator: dataset
    properties:
      - platform
      - name
      - env
      - versionId
    aspects:
      datasetProperties: versioned
      schemaMetadata: versioned
      ownership: versioned
      globalTags: versioned
      datasetProfile: timeseries
    relationships:
      - type: HAS_COLUMN
        target: Column
        direction: outgoing
        # Relationship creation parameters for independent ingestion
        entity_creation:
          source_entity:
            entity_type: "Dataset"
            urn_generator: "dataset"
            required_params: ["platform", "name"]
            optional_params: ["env"]
          target_entity:
            entity_type: "Column"
            urn_generator: "column"
            required_params: ["dataset_urn", "field_path"]
            optional_params: []
      - type: TAGGED
        target: Tag
        direction: outgoing
        properties: ["source"]
        entity_creation:
          source_entity:
            entity_type: "Dataset"
            urn_generator: "dataset"
            required_params: ["platform", "name"]
            optional_params: ["env"]
          target_entity:
            entity_type: "Tag"
            urn_generator: "tag"
            required_params: ["key"]
            optional_params: ["value"]
      - type: UPSTREAM_OF
        target: Dataset
        direction: outgoing
        properties: ["via"]
        entity_creation:
          source_entity:
            entity_type: "Dataset"
            urn_generator: "dataset"
            required_params: ["platform", "name"]
            optional_params: ["env"]
          target_entity:
            entity_type: "Dataset"
            urn_generator: "dataset"
            required_params: ["platform", "name"]
            optional_params: ["env"]
      - type: OWNS
        target: CorpUser
        direction: incoming
        properties: ["via"]
        entity_creation:
          source_entity:
            entity_type: "CorpUser"
            urn_generator: "corpUser"
            required_params: ["username"]
            optional_params: []
          target_entity:
            entity_type: "Dataset"
            urn_generator: "dataset"
            required_params: ["platform", "name"]
            optional_params: ["env"]
      - type: OWNS
        target: CorpGroup
        direction: incoming
        properties: ["via"]
        entity_creation:
          source_entity:
            entity_type: "CorpGroup"
            urn_generator: "corpGroup"
            required_params: ["name"]
            optional_params: []
          target_entity:
            entity_type: "Dataset"
            urn_generator: "dataset"
            required_params: ["platform", "name"]
            optional_params: ["env"]

  DataFlow:
    key: dataFlowKey
    urn_generator: dataFlow
    properties:
      - platform
      - flow_id
      - namespace
      - name
      - env
    aspects:
      dataFlowInfo: versioned
    relationships:
      - type: HAS_JOB
        target: DataJob
        direction: outgoing
        entity_creation:
          source_entity:
            entity_type: "DataFlow"
            urn_generator: "dataFlow"
            required_params: ["platform", "flow_id"]
            optional_params: ["env"]
          target_entity:
            entity_type: "DataJob"
            urn_generator: "dataJob"
            required_params: ["flow_urn", "job_name"]
            optional_params: []

  DataJob:
    key: dataJobKey
    urn_generator: dataJob
    properties:
      - flow_urn
      - job_name
    aspects:
      dataJobInfo: versioned
      documentation: versioned
      sourceCodeLocation: versioned
      sourceCode: versioned
      environmentProperties: versioned
      ownership: versioned
      dataJobInputOutput: versioned
      dataJobRun: timeseries
    relationships:
      - type: CONSUMES
        target: Dataset
        direction: outgoing
        entity_creation:
          source_entity:
            entity_type: "DataJob"
            urn_generator: "dataJob"
            required_params: ["flow_urn", "job_name"]
            optional_params: []
          target_entity:
            entity_type: "Dataset"
            urn_generator: "dataset"
            required_params: ["platform", "name"]
            optional_params: ["env"]
      - type: PRODUCES
        target: Dataset
        direction: outgoing
        entity_creation:
          source_entity:
            entity_type: "DataJob"
            urn_generator: "dataJob"
            required_params: ["flow_urn", "job_name"]
            optional_params: []
          target_entity:
            entity_type: "Dataset"
            urn_generator: "dataset"
            required_params: ["platform", "name"]
            optional_params: ["env"]
      - type: OWNS
        target: CorpUser
        direction: incoming
        properties: ["via"]
        entity_creation:
          source_entity:
            entity_type: "CorpUser"
            urn_generator: "corpUser"
            required_params: ["username"]
            optional_params: []
          target_entity:
            entity_type: "DataJob"
            urn_generator: "dataJob"
            required_params: ["flow_urn", "job_name"]
            optional_params: []
      - type: OWNS
        target: CorpGroup
        direction: incoming
        properties: ["via"]
        entity_creation:
          source_entity:
            entity_type: "CorpGroup"
            urn_generator: "corpGroup"
            required_params: ["name"]
            optional_params: []
          target_entity:
            entity_type: "DataJob"
            urn_generator: "dataJob"
            required_params: ["flow_urn", "job_name"]
            optional_params: []

  CorpUser:
    key: corpUserKey
    urn_generator: corpUser
    properties:
      - username
    aspects:
      corpUserInfo: versioned
      ownership: versioned
    relationships:
      - type: OWNS
        target: Dataset
        direction: outgoing
        properties: ["via"]
        entity_creation:
          source_entity:
            entity_type: "CorpUser"
            urn_generator: "corpUser"
            required_params: ["username"]
            optional_params: []
          target_entity:
            entity_type: "Dataset"
            urn_generator: "dataset"
            required_params: ["platform", "name"]
            optional_params: ["env"]
      - type: OWNS
        target: DataJob
        direction: outgoing
        properties: ["via"]
        entity_creation:
          source_entity:
            entity_type: "CorpUser"
            urn_generator: "corpUser"
            required_params: ["username"]
            optional_params: []
          target_entity:
            entity_type: "DataJob"
            urn_generator: "dataJob"
            required_params: ["flow_urn", "job_name"]
            optional_params: []

  CorpGroup:
    key: corpGroupKey
    urn_generator: corpGroup
    properties:
      - name
    aspects:
      corpGroupInfo: versioned
      ownership: versioned
    relationships:
      - type: OWNS
        target: Dataset
        direction: outgoing
        properties: ["via"]
        entity_creation:
          source_entity:
            entity_type: "CorpGroup"
            urn_generator: "corpGroup"
            required_params: ["name"]
            optional_params: []
          target_entity:
            entity_type: "Dataset"
            urn_generator: "dataset"
            required_params: ["platform", "name"]
            optional_params: ["env"]
      - type: OWNS
        target: DataJob
        direction: outgoing
        properties: ["via"]
        entity_creation:
          source_entity:
            entity_type: "CorpGroup"
            urn_generator: "corpGroup"
            required_params: ["name"]
            optional_params: []
          target_entity:
            entity_type: "DataJob"
            urn_generator: "dataJob"
            required_params: ["flow_urn", "job_name"]
            optional_params: []

  Tag:
    key: tagKey
    urn_generator: tag
    properties:
      - key
      - value
    aspects: {}
    relationships:
      - type: TAGGED
        target: Dataset
        direction: incoming
        entity_creation:
          source_entity:
            entity_type: "Tag"
            urn_generator: "tag"
            required_params: ["key"]
            optional_params: ["value"]
          target_entity:
            entity_type: "Dataset"
            urn_generator: "dataset"
            required_params: ["platform", "name"]
            optional_params: ["env"]

  Column:
    key: columnKey
    urn_generator: column
    properties:
      - dataset_urn
      - field_path
    aspects:
      columnProperties: versioned
      transformation: versioned
    relationships:
      - type: DERIVES_FROM
        target: Column
        direction: outgoing
        properties: ["type", "subtype", "description", "transformation", "source_dataset", "target_dataset"]
        entity_creation:
          source_entity:
            entity_type: "Column"
            urn_generator: "column"
            required_params: ["dataset_urn", "field_path"]
            optional_params: []
          target_entity:
            entity_type: "Column"
            urn_generator: "column"
            required_params: ["dataset_urn", "field_path"]
            optional_params: []

# Aspect Types
aspect_types:
  versioned:
    base_class: "Versioned"
    properties: ["id", "name", "version", "kind", "json", "createdAt"]
    query_pattern: "MATCH (e:{entity_label} {{urn:$urn}})-[:HAS_ASPECT {{name:$an}}]->(a:Aspect:Versioned)"
  
  timeseries:
    base_class: "TimeSeries"
    properties: ["id", "name", "ts", "kind", "json", "createdAt"]
    query_pattern: "MATCH (e:{entity_label} {{urn:$urn}})-[:HAS_ASPECT {{name:$an}}]->(a:Aspect:TimeSeries)"
