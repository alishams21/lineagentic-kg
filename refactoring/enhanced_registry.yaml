# Enhanced Registry with URN patterns, relationships, and generation rules
metadata:
  version: "1.0"
  description: "Enhanced registry for dynamic Neo4jMetadataWriter generation"
  urn_prefix: "urn:li"

# URN Generation Patterns
urn_patterns:
  dataPlatform:
    template: "{prefix}:dataPlatform:{platform}"
    parameters: ["platform"]
    sanitize: ["platform"]
  
  dataset:
    template: "{prefix}:dataset:({data_platform_urn},{name},{env})"
    parameters: ["platform", "name", "env"]
    defaults: {"env": "PROD"}
    dependencies: ["dataPlatform"]
    sanitize: ["name"]
  
  dataFlow:
    template: "{prefix}:dataFlow:({platform},{flow_id},{env})"
    parameters: ["platform", "flow_id", "env"]
    defaults: {"env": "PROD"}
    sanitize: ["platform", "flow_id"]
  
  dataJob:
    template: "{prefix}:dataJob:({flow_urn},{job_name})"
    parameters: ["flow_urn", "job_name"]
    sanitize: ["job_name"]
  
  corpUser:
    template: "{prefix}:corpuser:{username}"
    parameters: ["username"]
    sanitize: ["username"]
    transformations: {"username": "email_to_username"}
  
  corpGroup:
    template: "{prefix}:corpGroup:{groupname}"
    parameters: ["groupname"]
    sanitize: ["groupname"]
  
  tag:
    template: "{prefix}:tag:{key}{value_suffix}"
    parameters: ["key", "value"]
    sanitize: ["key", "value"]
    conditional_logic: "value_suffix"
    conditional_rules:
      value_suffix:
        when_value_present: "={value}"
        when_value_absent: ""
  
  column:
    template: "{dataset_urn}#{field_path}"
    parameters: ["dataset_urn", "field_path"]
    sanitize: ["field_path"]

# Aspect Definitions
aspects:
  corpUserInfo:
    type: versioned
    properties:
      - active
      - displayName
      - email
      - title
      - department
      - managerUrn
      - skills
    required: ["active", "displayName", "email"]
    defaults:
      active: true
    # Entity creation parameters for independent ingestion
    entity_creation:
      entity_type: "CorpUser"
      urn_generator: "corpUser"
      required_params: ["username"]
      optional_params: []
  
  corpGroupInfo:
    type: versioned
    properties:
      - name
      - description
      - email
      - slackChannel
    required: ["name"]
    entity_creation:
      entity_type: "CorpGroup"
      urn_generator: "corpGroup"
      required_params: ["name"]
      optional_params: []
  
  datasetProperties:
    type: versioned
    properties:
      - description
      - customProperties
      - tags
      - externalUrl
    required: ["description"]
    entity_creation:
      entity_type: "Dataset"
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  schemaMetadata:
    type: versioned
    properties:
      - schemaName
      - platform
      - version
      - fields
      - primaryKeys
      - foreignKeys
    required: ["schemaName", "platform", "fields"]
    entity_creation:
      entity_type: "Dataset"
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  ownership:
    type: versioned
    properties:
      - owners
      - lastModified
    required: ["owners"]
    # Ownership can be attached to multiple entity types
    # Entity creation will be determined by the context where it's used
    entity_creation:
      entity_type: "Dataset"  # Default to Dataset, but can be overridden
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  globalTags:
    type: versioned
    properties:
      - tags
    required: ["tags"]
    # Global tags can be attached to multiple entity types
    # Entity creation will be determined by the context where it's used
    entity_creation:
      entity_type: "Dataset"  # Default to Dataset, but can be overridden
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  datasetProfile:
    type: timeseries
    properties:
      - rowCount
      - columnCount
      - sizeInBytes
      - lastModified
      - partitionCount
    required: ["rowCount", "columnCount"]
    entity_creation:
      entity_type: "Dataset"
      urn_generator: "dataset"
      required_params: ["platform", "name"]
      optional_params: ["env"]
  
  dataFlowInfo:
    type: versioned
    properties:
      - name
      - namespace
      - description
      - version
    required: ["name", "namespace"]
    entity_creation:
      entity_type: "DataFlow"
      urn_generator: "dataFlow"
      required_params: ["platform", "flow_id"]
      optional_params: ["env"]
  
  dataJobInfo:
    type: versioned
    properties:
      - name
      - namespace
      - versionId
      - integration
      - processingType
      - jobType
      - description
    required: ["name", "namespace"]
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  documentation:
    type: versioned
    properties:
      - description
      - contentType
      - content
    required: ["description"]
    # Documentation is typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  sourceCodeLocation:
    type: versioned
    properties:
      - type
      - url
      - repo
      - branch
      - path
    required: ["type", "url"]
    # Source code location is typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  sourceCode:
    type: versioned
    properties:
      - language
      - snippet
      - fullCode
    required: ["language"]
    # Source code is typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  environmentProperties:
    type: versioned
    properties:
      - env
      - config
    required: ["env"]
    # Environment properties are typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  dataJobInputOutput:
    type: versioned
    properties:
      - inputs
      - outputs
    required: ["inputs", "outputs"]
    # Data job I/O is typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  dataJobRun:
    type: timeseries
    properties:
      - eventType
      - runId
      - parent
      - status
      - startTime
      - endTime
    required: ["eventType", "runId"]
    # Data job runs are typically attached to DataJob entities
    entity_creation:
      entity_type: "DataJob"
      urn_generator: "dataJob"
      required_params: ["flow_urn", "job_name"]
      optional_params: []
  
  columnProperties:
    type: versioned
    properties:
      - description
      - dataType
      - nullable
      - defaultValue
    required: ["dataType"]
    entity_creation:
      entity_type: "Column"
      urn_generator: "column"
      required_params: ["dataset_urn", "field_path"]
      optional_params: []
  
  transformation:
    type: versioned
    properties:
      - inputColumns
      - steps
      - notes
      - sourceDataset
      - targetDataset
      - transformationType
    required: ["inputColumns", "transformationType"]
    defaults:
      sourceDataset: null
      targetDataset: null
    entity_creation:
      entity_type: "Column"
      urn_generator: "column"
      required_params: ["dataset_urn", "field_path"]
      optional_params: []

# Entity Definitions
entities:
  Dataset:
    key: datasetKey
    urn_generator: dataset
    properties:
      - platform
      - name
      - env
      - versionId
    aspects:
      datasetProperties: versioned
      schemaMetadata: versioned
      ownership: versioned
      globalTags: versioned
      datasetProfile: timeseries

  DataFlow:
    key: dataFlowKey
    urn_generator: dataFlow
    properties:
      - platform
      - flow_id
      - namespace
      - name
      - env
    aspects:
      dataFlowInfo: versioned

  DataJob:
    key: dataJobKey
    urn_generator: dataJob
    properties:
      - flow_urn
      - job_name
    aspects:
      dataJobInfo: versioned
      documentation: versioned
      sourceCodeLocation: versioned
      sourceCode: versioned
      environmentProperties: versioned
      ownership: versioned
      dataJobInputOutput: versioned
      dataJobRun: timeseries

  CorpUser:
    key: corpUserKey
    urn_generator: corpUser
    properties:
      - username
    aspects:
      corpUserInfo: versioned
      ownership: versioned

  CorpGroup:
    key: corpGroupKey
    urn_generator: corpGroup
    properties:
      - name
    aspects:
      corpGroupInfo: versioned
      ownership: versioned

  Tag:
    key: tagKey
    urn_generator: tag
    properties:
      - key
      - value
    aspects: {}

  Column:
    key: columnKey
    urn_generator: column
    properties:
      - dataset_urn
      - field_path
    aspects:
      columnProperties: versioned
      transformation: versioned

# Aspect Types
aspect_types:
  versioned:
    base_class: "Versioned"
    properties: ["id", "name", "version", "kind", "json", "createdAt"]
    query_pattern: "MATCH (e:{entity_label} {{urn:$urn}})-[:HAS_ASPECT {{name:$an}}]->(a:Aspect:Versioned)"
  
  timeseries:
    base_class: "TimeSeries"
    properties: ["id", "name", "ts", "kind", "json", "createdAt"]
    query_pattern: "MATCH (e:{entity_label} {{urn:$urn}})-[:HAS_ASPECT {{name:$an}}]->(a:Aspect:TimeSeries)"

# Aspect-Driven Relationship Rules
aspect_relationships:
  ownership:
    description: "Creates OWNS relationships from ownership aspect data"
    rules:
      - entity_type: "Dataset"
        relationship_type: "OWNS"
        source_entity: "CorpUser"
        target_entity: "Dataset"
        direction: "incoming"
        field_mapping:
          source_field: "owners[].owner"
          source_entity_type: "CorpUser"
          source_urn_field: "username"
          target_entity_type: "Dataset"
          target_urn_field: "urn"
      - entity_type: "Dataset"
        relationship_type: "OWNS"
        source_entity: "CorpGroup"
        target_entity: "Dataset"
        direction: "incoming"
        field_mapping:
          source_field: "owners[].owner"
          source_entity_type: "CorpGroup"
          source_urn_field: "name"
          target_entity_type: "Dataset"
          target_urn_field: "urn"
      - entity_type: "DataJob"
        relationship_type: "OWNS"
        source_entity: "CorpUser"
        target_entity: "DataJob"
        direction: "incoming"
        field_mapping:
          source_field: "owners[].owner"
          source_entity_type: "CorpUser"
          source_urn_field: "username"
          target_entity_type: "DataJob"
          target_urn_field: "urn"
      - entity_type: "DataJob"
        relationship_type: "OWNS"
        source_entity: "CorpGroup"
        target_entity: "DataJob"
        direction: "incoming"
        field_mapping:
          source_field: "owners[].owner"
          source_entity_type: "CorpGroup"
          source_urn_field: "name"
          target_entity_type: "DataJob"
          target_urn_field: "urn"

  globalTags:
    description: "Creates TAGGED relationships from globalTags aspect data"
    rules:
      - entity_type: "Dataset"
        relationship_type: "TAGGED"
        source_entity: "Dataset"
        target_entity: "Tag"
        direction: "outgoing"
        field_mapping:
          source_field: "tags[].tag"
          source_entity_type: "Dataset"
          source_urn_field: "urn"
          target_entity_type: "Tag"
          target_urn_field: "key"

  transformation:
    description: "Creates DERIVES_FROM and UPSTREAM_OF relationships from transformation aspect data"
    rules:
      - entity_type: "Column"
        relationship_type: "DERIVES_FROM"
        source_entity: "Column"
        target_entity: "Column"
        direction: "outgoing"
        field_mapping:
          source_field: "inputColumns[]"
          source_entity_type: "Column"
          source_urn_field: "urn"
          target_entity_type: "Column"
          target_urn_field: "urn"
          source_urn_template: "{sourceDataset}#{source_field}"
          target_urn_template: "{targetDataset}#{field_path}"
        additional_relationships:
          - relationship_type: "UPSTREAM_OF"
            source_entity: "Dataset"
            target_entity: "Dataset"
            direction: "outgoing"
            field_mapping:
              source_field: "sourceDataset"
              target_field: "targetDataset"

  schemaMetadata:
    description: "Creates HAS_COLUMN relationships from schemaMetadata aspect data"
    rules:
      - entity_type: "Dataset"
        relationship_type: "HAS_COLUMN"
        source_entity: "Dataset"
        target_entity: "Column"
        direction: "outgoing"
        field_mapping:
          source_field: "fields[].fieldPath"
          source_entity_type: "Dataset"
          source_urn_field: "urn"
          target_entity_type: "Column"
          target_urn_field: "urn"
          target_urn_template: "{source_urn}#{source_field}"

  dataJobInputOutput:
    description: "Creates CONSUMES and PRODUCES relationships from dataJobInputOutput aspect data"
    rules:
      - entity_type: "DataJob"
        relationship_type: "CONSUMES"
        source_entity: "DataJob"
        target_entity: "Dataset"
        direction: "outgoing"
        field_mapping:
          source_field: "inputs[]"
          source_entity_type: "DataJob"
          source_urn_field: "urn"
          target_entity_type: "Dataset"
          target_urn_field: "urn"
      - entity_type: "DataJob"
        relationship_type: "PRODUCES"
        source_entity: "DataJob"
        target_entity: "Dataset"
        direction: "outgoing"
        field_mapping:
          source_field: "outputs[]"
          source_entity_type: "DataJob"
          source_urn_field: "urn"
          target_entity_type: "Dataset"
          target_urn_field: "urn"

  dataFlowInfo:
    description: "Creates HAS_JOB relationships from dataFlowInfo aspect data"
    rules:
      - entity_type: "DataFlow"
        relationship_type: "HAS_JOB"
        source_entity: "DataFlow"
        target_entity: "DataJob"
        direction: "outgoing"
        field_mapping:
          source_field: "jobs[]"
          source_entity_type: "DataFlow"
          source_urn_field: "urn"
          target_entity_type: "DataJob"
          target_urn_field: "urn"
          target_urn_template: "{source_urn}#{job_name}"
