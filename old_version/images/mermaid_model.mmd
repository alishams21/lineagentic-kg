graph TD

%% =========================
%% Subgraphs
%% =========================
subgraph Jobs
  j[Job\nkey, namespace, name, updatedAt]
  js[JobSnapshot\njobKey, eventTime, versionId,\nprocessingType, integration, jobType, description]
  sc[SourceCode\nlanguage, path, branch, version]
  repo[Repo\nurl]
end

subgraph Datasets
  %% Generic INPUT dataset & snapshots/fields
  ds_in[Dataset input\nkey, namespace, name, updatedAt]
  dss_in[DatasetSnapshot input\ndatasetKey, eventTime, versionId,\nrowCount, fileCount, size]
  fld_in[Field input\ndatasetKey, name]
  fss_in[FieldSnapshot input\ndatasetKey, fieldName, eventTime,\nversionId, type, description]

  %% Generic OUTPUT dataset & snapshots/fields
  ds_out[Dataset output\nkey, namespace, name, updatedAt]
  dss_out[DatasetSnapshot output\ndatasetKey, eventTime, versionId,\nrowCount, fileCount, size]
  ofld_out[Field output\ndatasetKey, name]
  ofss_out[FieldSnapshot output\ndatasetKey, fieldName, eventTime,\nversionId]

  %% Shared taxonomy/metadata
  owner[Owner\nname, type]
  tag[Tag\nkey, value, source]
  tr[Transformation\ntype, subtype, description, masking]
end

subgraph Runs
  r[Run\nrunId, eventType, eventTime]
end

%% =========================
%% Job & Run
%% =========================
j -- HAS_SNAPSHOT --> js
r -- OF_JOB --> js

%% Source code facets (job)
js -- HAS_SOURCE --> sc
sc -- IN_REPO --> repo

%% Job owners
j -- OWNED_BY --> owner

%% =========================
%% INPUT datasets
%% =========================
ds_in -- HAS_SNAPSHOT --> dss_in
ds_in -- LATEST --> dss_in
ds_in -- OWNED_BY --> owner
ds_in -- TAGGED --> tag

%% Input fields & snapshots
ds_in -- HAS_FIELD --> fld_in
fld_in -- HAS_SNAPSHOT --> fss_in
fld_in -- LATEST --> fss_in

%% Job/Run usage of inputs
js -- READS_FROM --> dss_in
r  -- USED --> dss_in

%% =========================
%% OUTPUT datasets
%% =========================
ds_out -- HAS_SNAPSHOT --> dss_out
ds_out -- LATEST --> dss_out
ds_out -- OWNED_BY --> owner
ds_out -- TAGGED --> tag

%% Output fields & snapshots
ds_out -- HAS_FIELD --> ofld_out
ofld_out -- HAS_SNAPSHOT --> ofss_out
ofld_out -- LATEST --> ofss_out

%% Job/Run writes of outputs
js -- WRITES_TO --> dss_out
r  -- WROTE --> dss_out

%% =========================
%% Lineage
%% =========================
%% Dataset-level lineage (per-run)
dss_out -- "DERIVES_FROM {runId}" --> dss_in

%% Column-level lineage (per-run) + transformations
ofss_out -- "DERIVES_FROM {runId}" --> fss_in
ofss_out -- USING_TRANSFORMATION --> tr
